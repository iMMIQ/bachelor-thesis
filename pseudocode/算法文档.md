# 算法文档

> 输入：三维障碍物信息，起点和终点

> 输出：布线信息

## 总步骤

1. 将输入的三维障碍物表面转换为若干矩形

2. 在这些矩形内随机生成稀疏的点，连接相距一定距离的点形成边集，计算最短路径，记录路径经过的矩形

3. 将矩形依据重叠的边是否平行，分为若干组矩形集，这些集合交界的垂直的边上取一个点，作为路径的中间点，通过Nelder-Mead算法优化出最优点的位置集合

4. 对于每组矩形集，计算第四步得到的点之间的最短路径

## 算法4

### 步骤

1. 将空间中的矩形通过几何变换为x-y平面上的二维矩形，同时映射起点和终点位置

2. 通过dp计算出二维平面上矩形集内起点到终点的最短路径

3. 将路径上的点的位置映射回原本的矩形内

### 算法4.1：旋转矩形集

> 输入：矩形集（每个矩形由三个空间顶点的坐标定义）

> 输出：矩形集（每个矩形由左下和右上两个平面点坐标定义）

#### 步骤

1. 将矩形集整体绕x轴旋转，使得边界上矩形的底边与y轴垂直

2. 矩形集平移，使得一个矩形的顶点位于原点

3. 继续绕y轴旋转，使得这个矩形底边在x轴上

4. 继续绕x轴旋转，使得这个矩形顶边在x-y平面上，此时整个矩形在x-y平面上

5. 从矩形集中移除这个矩形，重复这些步骤，直到所有矩形被移除矩形集

##### 算法4.1.1

```

move := r0.LL

FOR r in set

    FOR p in [r.LL, r.LR, r.UR]

        p := p - move

```

##### 算法4.1.2

对于空间点绕x轴旋转$\theta$ °，旋转后坐标为

$ \begin{bmatrix}
 x' & y' & z' & 1
\end{bmatrix} = \begin{bmatrix}
 x & y & z & 1
\end{bmatrix}\begin{bmatrix}
 1 & 0 & 0 & 0\\
 0 & \cos \theta & \sin \theta & 0\\
 0 & -\sin \theta & \cos \theta & 0\\
 0 & 0 & 0 & 1
\end{bmatrix} $

$x' = x$

$y' = y \cos \theta - z \sin \theta$

$z' = y \sin \theta + z \cos \theta$

因此首先需要求解$\theta$使得$y'_{右下顶点} = y \cos \theta - z \sin \theta = y_{左下顶点}$

对于方程$a \cos \theta - b \sin \theta = c$

$\theta$的一组解为：

$x=\begin{cases}
2 \tan ^ {-1} \frac{\sqrt{a^2+b^2-c^2}-b}{a + c} \text{ if } a \ne c \And a^2 + ac + b^2 \ne b \sqrt{a^2+b^2-c^2} \\
2 \tan ^ {-1} \frac{-\sqrt{a^2+b^2-c^2}-b}{a + c} \text{ if } a \ne c \And a^2 + ac + b^2 + b \sqrt{a^2+b^2-c^2} \ne 0 \\
2 \tan ^ {-1} \frac{a}{b} \text{ if } b \ne 0 \And a + c =0
\end{cases}$

将这个解代入回上面的旋转，旋转整个矩形集上的关键点

```

r0 := set.first

// LR表示右下点，LL表示左下点, UR表示右上点

theta := solve(r0.LR.y, r0.LR.z, r0.LL.y)

FOR_EACH r in set: rotate around the x-axis(theta)

```

##### 算法4.1.3

对于空间点绕y轴旋转$\theta$ °，旋转后坐标为

$\begin{bmatrix}
 x' & y' & z' & 1
\end{bmatrix} = \begin{bmatrix}
 x & y & z & 1
\end{bmatrix}\begin{bmatrix}
 \cos \theta & 0 & -\sin \theta & 0\\
 0 & 1 & 0 & 0\\
 \sin \theta & 0 & \cos \theta & 0\\
 0 & 0 & 0 & 1
\end{bmatrix}$

$x' = z \sin \theta + x \cos \theta$

$y' = y$

$z' = z \cos \theta - x \sin \theta$

由于此时矩形左下点在原点，底边与y轴垂直，因此此时绕y轴旋转一定角度，可以使得底边与x轴重合，角度$\theta$满足$z' = z \cos \theta - x \sin \theta = 0$，$\theta = \tan^{-1}\frac{z}{x}$，这里的$[x\ y\ z]$来自r0.LR

##### 算法4.1.4

此时，矩形底边与x轴重合，只需绕x轴旋转，使r0.UR.z=0，则满足矩形存在三个顶点在x-y平面上，矩形即在x-y平面上。

$z' = y \sin \theta + z \cos \theta = 0$

$\theta = - \tan^{-1} \frac{z}{y}$

这里的$[x\ y\ z]$来自r0.UR

#### 算法4.2：映射点

> 输入：点x，矩形r0，映射矩形r0'

> 输出：映射点x'

若令

$\vec{A} = r0.LL - r0.LR$

$\vec{B} = r0.UR - r0.LR$

$\vec{C} = x - r0.LR$

则有：$\vec{C} = a \cdot \vec{A} + b \cdot \vec{B}$

解得：

$a = \begin{cases}
\frac{C_xB_y-B_xC_y}{A_xB_y-B_xA_y} \text{ if } A_xB_y \ne B_xA_y \\
\frac{C_yB_z-B_yC_z}{A_yB_z-B_yA_z} \text{ if } A_yB_z \ne B_yA_z \\
\frac{C_xB_z-B_xC_z}{A_xB_z-B_xA_z} \text{ if } A_xB_z \ne B_xA_z
\end{cases}$

$b = \begin{cases}
\frac{A_xC_y-C_xA_y}{A_xB_y-B_xA_y} \text{ if } A_xB_y \ne B_xA_y \\
\frac{A_yC_z-C_yA_z}{A_yB_z-B_yA_z} \text{ if } A_yB_z \ne B_yA_z \\
\frac{A_xC_z-C_xA_z}{A_xB_z-B_xA_z} \text{ if } A_xB_z \ne B_xA_z
\end{cases}$

这表示了矩形内一点相对于矩形三个顶点的位置，因此可以映射为

$x' = r0'.LR + a \cdot \vec{A'} + b \cdot \vec{B'}$

#### 算法4.3：求解二维平面内单向矩形集内最短路径

令$dp_{i,0}$表示从矩形交界最低点离开矩形最短路径长度，$dp_{i,1}$表示从矩形交界最高点离开矩形最短路径长度，状态转移方程为：
